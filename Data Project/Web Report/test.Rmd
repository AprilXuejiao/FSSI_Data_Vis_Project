---
title: "Social Services Charities in Victoria"
output:
  html_document:
    fig_height: 7
    fig_width: 8
    toc: true
    number_sections: false
    toc_depth: 2
    toc_float:
      smooth_scroll: true
    includes:
      in_header: logos_header.html
mainfont: TradeGothic LT, sans-serif
---

<style>
body{
  
  font-family: TradeGothic LT;
  margin:0 auto;
  
}

element.style{

font-family: TradeGothic LT;

}

div.logos{

  max-width:600px;
  position:relative;
  margin:0 auto;

}

</style>

```{r, warning=F, echo=F, message=F}

# packages

if(!("pacman" %in% rownames(installed.packages()))) {
  
  install.packages("pacman")
  require(pacman)
  
} else {
  
  require(pacman)
  
}

p_load(tidyverse,
       rmarkdown,
       plotly,
       ggplotlyExtra,
       readxl,
       janitor,
       scales,
       grid,
       gridExtra,
       lemon,
       zoo,
       knitr)

```


```{r, warning=F, echo=F, message=F}

# utilities

# setting global colour scheme

## A single grey
GreySingle <- "grey55"

## A gradient of greys
GreyGrad <- function(n_colours){div_gradient_pal(low = "grey30",
                                                 mid = GreySingle,
                                                 high = "grey80")(seq(0, 1, length.out = n_colours))}

## A single green
FSSIGreenSingle <- "#549041"

## a gradient of greens
FSSIGreenGrad <- function(n_colours){div_gradient_pal(low = "#3d6a2f",
                                                      mid = FSSIGreenSingle,
                                                      high = "#84c072")(seq(0, 1, length.out = n_colours))}


## Setting a very light variant of FSSI green for backgrounds

FSSIUltraLight <- "#96ffa2"

## Setting default font

FSSIfont <- "TradeGothic LT"



# useful function maybe

m_round <- function(num, mult = 10) {
  
  round( (num+0.00001) / mult) * mult
  
}

str_cleaner <- function(str_input) {
  
  
  str_to_title(str_replace_all(str_input, "_", " "))
  
}

str_clean_wrap <- function(str_input, n_characters = 20) {
  
  str_wrap(str_to_title(str_replace_all(str_input, "_", " ")),
           width = n_characters)
  
}

```

```{r, warning=F, echo=F, message=F}

# reading in 2016 data

VCOSS_ACNC_16 <- clean_names(read_excel("VCOSS Data/VCOSS - 2016 ACNC Data.xlsx"), "snake")

## `main_activity` contains "Social services and SOCIAL_SERVICES

VCOSS_ACNC_16$main_activity_2016 <- str_cleaner(VCOSS_ACNC_16$main_activity_2016)

VCOSS_ACNC_16$charity_size <- str_to_title(VCOSS_ACNC_16$charity_size)

# reading in 2017 data

VCOSS_ACNC_17 <- clean_names(read_excel("VCOSS Data/VCOSS - 2017 ACNC Data.xlsx"), "snake")

VCOSS_ACNC_17$main_activity <- str_cleaner(VCOSS_ACNC_17$main_activity)

VCOSS_ACNC_17$charity_size <- str_to_title(VCOSS_ACNC_17$charity_size)

## recoding any y or n cols to bool

for(col_name in colnames(VCOSS_ACNC_16)) {
  
  if(c("n", "y") %in% unique(VCOSS_ACNC_16[[col_name]]) == c(T, T)) {
    
    VCOSS_ACNC_16[[col_name]] <- recode(VCOSS_ACNC_16[[col_name]],
                                        "n" = F,
                                        "y" = T)
    
    
    
  }
}

for(col_name in colnames(VCOSS_ACNC_17)) {
  
  if(c("n", "y") %in% unique(VCOSS_ACNC_17[[col_name]]) == c(T, T)) {
    
    VCOSS_ACNC_17[[col_name]] <- recode(VCOSS_ACNC_17[[col_name]],
                                        "n" = F,
                                        "y" = T)
    
    
    
  }
}


# Recoding "Emergency and Relief" in 2017 data to "Emergency Relief" to align with 2016

VCOSS_ACNC_17$main_activity <- if_else(str_detect(VCOSS_ACNC_17$main_activity,
                                                  regex("Emergency and Relief", ignore_case = TRUE)),
                                       true = "Emergency Relief",
                                       false = VCOSS_ACNC_17$main_activity)


```


```{r, warning=F, echo=F, message=F}

# Removing Invalid ABNs

## Reference Keybreaker file

ABN_Keybreaker <- read_excel("VCOSS Data/ABN Keybreaker.xlsx")

## Function for checking ABNs

ABN_Checker <- function(ABN_No) {
  
  sumproduct <- c()
  
  for(position in 1:nchar(ABN_No)) {
    
    number <- as.numeric(substr(ABN_No, position, position))  
    
    if(position == 1) {
      
      number <- as.numeric(number - 1)
      
    }
    
    product <- (number * ABN_Keybreaker$Weighting[position])
    
    sumproduct <- sum(sumproduct, product)
    
  }
  
  if(sumproduct %% 89 == 0) {
    
    Check <- "Valid ABN"
    
  } else {
    
    Check <- "Invalid ABN"
    
  }
  
  return(Check)
  
}

ABN_Validator <- function(ABN_vector) {
  
  sapply(ABN_vector, ABN_Checker)
  
}



VCOSS_ACNC_16 <- mutate(VCOSS_ACNC_16,
                        ABN_Validation = ABN_Validator(abn))

Invalid_ABNs_16 <- filter(VCOSS_ACNC_16,
                          ABN_Validation == "Invalid ABN")

VCOSS_ACNC_17 <- mutate(VCOSS_ACNC_17,
                        ABN_Validation = ABN_Validator(abn))

Invalid_ABNs_17 <- filter(VCOSS_ACNC_17,
                          ABN_Validation == "Invalid ABN")


## Filter out invalid ABNs from VCOSS dataframes

VCOSS_ACNC_16 <- VCOSS_ACNC_16[which(!(VCOSS_ACNC_16$abn %in% Invalid_ABNs_16$abn)), ]

VCOSS_ACNC_17 <- VCOSS_ACNC_17[which(!(VCOSS_ACNC_17$abn %in% Invalid_ABNs_17$abn)), ]


```

# Foreword

The social services sector in Victoria is a multi billion dollar sector providing a range of services with the common focus of reducing poverty and disadvantage experienced by Victorians. The sector employs thousands of Victorians, making a substantial contribution to the state economy. In addition to this, there are a large number of charities and not-for-profit organisations that operate within the social services sector in Victoria, often deriving funding from very different sources than that of their privately-run counterparts.  

As the social services sector in Victoria is so large and complex, this report dives into the data to better understand its composition and characteristics. The below report and data visualisations make use of data provided by the [Australian Charities and Not-for-profits Commission (ACNC)](https://www.acnc.gov.au) to examine the impact of charities and not-for-profit organisations in the social services sector in Victoria. This report also looks at changes in the nature of the charities and not-for-profits in the social services sector between 2016 and 2017.

# Sector Size and Composition {.tabset .tabset-pills}

```{r echo=FALSE, message=FALSE, warning=FALSE}

## Creating counts for below text

Count_MainAct_16 <- summarise(group_by(VCOSS_ACNC_16,
                                       main_activity_2016),
                              Count = n())

Count_MainAct_17 <- summarise(group_by(VCOSS_ACNC_17,
                                       main_activity),
                              Count = n())

SocServ16 <- Count_MainAct_16$Count[which(str_detect(Count_MainAct_16$main_activity_2016, "Social Services"))]

TotalCount16 <- sum(Count_MainAct_16$Count)

SocServ17 <- Count_MainAct_17$Count[which(str_detect(Count_MainAct_17$main_activity, "Social Services"))]

TotalCount17 <- sum(Count_MainAct_17$Count)

Count_MainAct_16 <- arrange(Count_MainAct_16, desc(Count))

Count_MainAct_17 <- arrange(Count_MainAct_17, desc(Count))

```

Charities operating in the social services sector comprise more than one out of every five charities operating in Victoria. In 2016 this was `r comma(SocServ16, 1)` charities, which decreased slighty in 2017 to `r comma(SocServ17, 1)` (`r percent(SocServ16 / TotalCount16, 0.1)` and `r percent(SocServ17 / TotalCount17, 0.1)` of total charities, respectively).  

In 2016, the largest number of charities were working in the Social Services sector with `r Count_MainAct_16$main_activity_2016[2]` recording the second-most number of charities at `r comma(Count_MainAct_16$Count[1], 1)`. These figures changed in 2017, with `r Count_MainAct_17$main_activity[1]` recording the greatest number of charities at `r comma(Count_MainAct_17$Count[1], 1)` while `r Count_MainAct_17$main_activity[2]` decreased slightly at `r comma(Count_MainAct_17$Count[2], 1)` charities.

## Yearly Totals {.tabset .tabset-fade}

### Social Services and all other Sectors

```{r echo=FALSE, message=FALSE, warning=FALSE}

# 2016

Counts_2016 <- mutate(VCOSS_ACNC_16,
                      Soc_Serv_Bool = if_else(str_detect(main_activity_2016, 
                                                         regex("social services",
                                                               ignore_case = T)),
                                              true = "Social Services",
                                              false = "Other sectors"))

Counts_2016 <- summarise(group_by(Counts_2016,
                                  Soc_Serv_Bool),
                         Count = n())

Counts_2016$Year <- 2016

# 2017

Counts_2017 <- mutate(VCOSS_ACNC_17,
                      Soc_Serv_Bool = if_else(str_detect(main_activity, 
                                                         regex("social services",
                                                               ignore_case = T)),
                                              true = "Social Services",
                                              false = "Other sectors"))

Counts_2017 <- summarise(group_by(Counts_2017,
                                  Soc_Serv_Bool),
                         Count = n())

Counts_2017$Year <- 2017

Counts_1617 <- rbind(Counts_2016, Counts_2017)

Counts_1617$Year <- as.ordered(Counts_1617$Year)

gg2_Counts_1617 <- ggplot(Counts_1617,
       aes(x = Year,
           y = Count,
           col = Soc_Serv_Bool,
           group = Soc_Serv_Bool,
           text = paste(sep = "\n",
                        Soc_Serv_Bool,
                        paste(comma(Count, 1), "charities")))) +
  geom_point() +
  geom_line() +
  scale_y_continuous("Number of Charities",
                     labels = comma_format(1),
                     limits = c(0, NA),
                     breaks = pretty_breaks(4)) +
  scale_x_discrete(expand = c(0.025, 0.025)) +
  scale_colour_manual("Sector",
                      values = c(GreySingle, FSSIGreenSingle)) +
  ggtitle("Number of Victorian Charities in Social Services and Other Sectors") +
  theme_minimal()

ggplotly(gg2_Counts_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont),
         legend = list(font = list(size = 9),
                       x = -0.25,
                       itemclick = "toggleothers",
                       itemdoubleclick = "toggle"))

```

### Breakdown per Main Activity

```{r echo=F, message=FALSE, warning=FALSE}

# Bringing 2016 and 2017 together for a bar chart

Vic_Char_Count17 <- summarise(group_by(VCOSS_ACNC_17,
                                       main_activity = as.factor(main_activity),
                                       .drop = F),
                              "Count" = n())

Vic_Char_Count17$Year <- 2017

Vic_Char_Count16 <- summarise(group_by(VCOSS_ACNC_16,
                                       main_activity = as.factor(main_activity_2016)),
                              "Count" = n())

Vic_Char_Count16$Year <- 2016

Vic_Char_Count_1617 <- rbind(Vic_Char_Count16, Vic_Char_Count17)

Vic_Char_Count_1617$Year <- as.ordered(Vic_Char_Count_1617$Year)

Vic_Char_Count_1617 <- replace_na(Vic_Char_Count_1617,
                                  replace = list(main_activity = "Not Specified"))


## bar chart

gg_Vic_Char_Count_1617 <- ggplot(Vic_Char_Count_1617,
                                 aes(x = Year, y = Count,
                                     group = main_activity, col = str_wrap(main_activity, width = 25),
                                     text = paste(sep = "\n",
                                                  paste("Count:", comma(Count, 1)),
                                                  main_activity))) +
  geom_point() +
  geom_line() +
  scale_y_continuous("Number of Charities",
                     labels = comma) +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  scale_colour_manual("Main Activity",
                      values = c(GreyGrad(length(unique(Vic_Char_Count_1617$main_activity))-1)[1:(length(unique(Vic_Char_Count_1617$main_activity))-1)],
                                 FSSIGreenSingle,
                                 GreyGrad(length(unique(Vic_Char_Count_1617$main_activity))-1)[length(unique(Vic_Char_Count_1617$main_activity))])) +
  ggtitle("Victorian Charities Main Activity, 2016 and 2017") +
  theme_minimal()

ggplotly(gg_Vic_Char_Count_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont),
         legend = list(x = -0.40,
                       font = list(size = 9),
                       itemclick = "toggleothers",
                       itemdoubleclick = "toggle"))

```

## Charity Sizes per Main Activity {.tabset .tabset-fade}

### 2016

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Charity size for each main activity

## 2016

Main_Act_Count_16 <- summarise(group_by(VCOSS_ACNC_16,
                                        main_activity_2016 = as.factor(main_activity_2016),
                                        charity_size = as.factor(charity_size),
                                        .drop = F),
                               Count = n())

for(activity in unique(Main_Act_Count_16$main_activity_2016)) {
  
  if(activity == "Social Services") {
    
    ColourGrad <- FSSIGreenGrad(3)
    
  } else {
    
    ColourGrad <- GreyGrad(3)
    
  }
  
  gg_temp <- ggplot(filter(Main_Act_Count_16,
                           main_activity_2016 == activity)) +
    geom_bar(aes(x = fct_rev(charity_size),
                 y = Count,
                 group = charity_size,
                 fill = charity_size,
                 alpha = main_activity_2016,
                 text = paste(sep = "\n",
                              alpha,
                              fill,
                              paste(..y.., "charities"))),
             show.legend = F, stat = "identity") +
    scale_fill_manual(values = ColourGrad) +
    scale_alpha_manual(values = rep(0.95, 3)) +
    scale_x_discrete("") +
    scale_y_continuous("Number of Charities",
                       labels = comma_format(accuracy = 1),
                       breaks = breaks_pretty(3)) +
    ggtitle("Charity Sizes per Main Activity, 2016") +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())
  
  pl_temp <- ggplotly(gg_temp,
                      tooltip = "text") %>%
    add_annotations(text = str_wrap(activity, width = 20),
                    x = 2,
                    y = 1.05,
                    yref = "paper",
                    xref = "x",
                    xanchor = "middle",
                    yanchor = "top",
                    align = "center",
                    showarrow = FALSE,
                    align = "center",
                    font = list(size = 10),
                    bgcolor = toRGB("white", alpha = 0.2))
  
  assign(paste0("pl_act16_", str_replace_all(activity, " ", "_")),
         value = pl_temp)
  
}

pl_act_list16 <- lapply(X = ls()[which(str_starts(ls(), "pl_act16_"))],
                      FUN = get)


subplot(pl_act_list16,
        nrows = 5) %>% 
  layout(showlegend = F,
         font = list(family = FSSIfont),
         height = 750, width = 750,
         margin = list(t = 35, b = 35,
                       l = 5, r = 5,
                       pad = 2))

```

### 2017

```{r echo=FALSE, message=FALSE, warning=FALSE}

## 2017

Main_Act_Count_17 <- summarise(group_by(VCOSS_ACNC_17,
                                        main_activity = as.factor(main_activity),
                                        charity_size = as.factor(charity_size),
                                        .drop = F),
                               Count = n())

for(activity in unique(Main_Act_Count_17$main_activity)) {
  
  if(activity == "Social Services") {
    
    ColourGrad <- FSSIGreenGrad(3)
    
  } else {
    
    ColourGrad <- GreyGrad(3)
    
  }
  
  gg_temp <- ggplot(filter(Main_Act_Count_17,
                           main_activity == activity)) +
    geom_bar(aes(x = fct_rev(charity_size),
                 y = Count,
                 group = charity_size,
                 fill = charity_size,
                 alpha = main_activity,
                 text = paste(sep = "\n",
                              alpha,
                              fill,
                              paste(..y.., "charities"))),
             show.legend = F, stat = "identity") +
    scale_fill_manual(values = ColourGrad) +
    scale_alpha_manual(values = rep(0.95, 3)) +
    scale_x_discrete("") +
    scale_y_continuous("Number of Charities",
                       labels = comma_format(accuracy = 1),
                       breaks = breaks_pretty(3)) +
    ggtitle("Charity Sizes per Main Activity, 2017") +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())
  
  pl_temp <- ggplotly(gg_temp,
                      tooltip = "text") %>%
    add_annotations(text = str_wrap(activity, width = 20),
                    x = 2,
                    y = 1.05,
                    yref = "paper",
                    xref = "x",
                    xanchor = "middle",
                    yanchor = "top",
                    align = "center",
                    showarrow = FALSE,
                    align = "center",
                    font = list(size = 10),
                    bgcolor = toRGB("white", alpha = 0.2))
  
  assign(paste0("pl_act17_", str_replace_all(activity, " ", "_")),
         value = pl_temp)
  
}

pl_act_list17 <- lapply(X = ls()[which(str_starts(ls(), "pl_act17_"))],
                        FUN = get)


subplot(pl_act_list17,
        nrows = 4) %>% 
  layout(showlegend = F,
         font = list(family = FSSIfont),
         height = 750, width = 750,
         margin = list(t = 35, b = 35,
                       l = 5, r = 5,
                       pad = 2))

```

### Change in Social Services Charity Sizes

```{r echo=FALSE, message=FALSE, warning=FALSE}

## TODO: this too

VIC_SocServ17 <- filter(VCOSS_ACNC_17,
                        str_detect(main_activity, regex("social services", ignore_case = T)))

VIC_SocServ17$Year <- 2017

VIC_SocServ17 <- select(VIC_SocServ17,
                        main_activity, charity_size, Year)

VIC_SocServ16 <- filter(VCOSS_ACNC_16,
                        str_detect(main_activity_2016, regex("social services", ignore_case = T)))

VIC_SocServ16$Year <- 2016

VIC_SocServ16 <- select(VIC_SocServ16,
                        main_activity = main_activity_2016,
                        charity_size, Year)

VIC_SocServ_1617 <- rbind(VIC_SocServ16, VIC_SocServ17)

VIC_SocServ_1617$Year <- as.ordered(VIC_SocServ_1617$Year)

Sum_VIC_SocServ_1617 <- summarise(group_by(VIC_SocServ_1617,
                                           Year, charity_size),
                                  n_Charities = n())

gg_Sum_VIC_SocServ_1617 <- ggplot(Sum_VIC_SocServ_1617,
                                  aes(x = Year, y = n_Charities,
                                      col = fct_rev(charity_size),
                                      group = fct_rev(charity_size),
                                      text = paste(sep = "\n",
                                                   paste("Count:", n_Charities),
                                                   paste("Charity size:", charity_size),
                                                   paste("Year:", Year)))) +
  geom_point(stat = "identity") +
  stat_summary(fun.y = sum, geom = "line") +
  scale_y_continuous("Number of Charities",
                     labels = comma,
                     limits = c(0, max(Sum_VIC_SocServ_1617$n_Charities)*1.1),
                     breaks = extended_breaks(6)) +
  scale_x_discrete("Year",
                   expand = c(0.05, 0.05)) +
  ggtitle("Victorian Social Services Charities, 2016 to 2017") +
  scale_color_manual("Charity Size",
                     values = rev(FSSIGreenGrad(3))) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

ggplotly(gg_Sum_VIC_SocServ_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont),
         legend = list(font = list(size = 9),
                       x = -0.25,
                       itemclick = "toggleothers",
                       itemdoubleclick = "toggle"))

```

# Sector Funding Sources {.tabset .tabset-pills}

## Total Funding by Year {.tabset .tabset-fade}

### Total Revenue Amount

```{r echo=FALSE, message=FALSE, warning=FALSE}

Revenue16 <- summarise(group_by(VCOSS_ACNC_16,
                                main_activity = main_activity_2016),
                       government_grants = sum(government_grants_2016,
                                               na.rm = T),
                       donations_and_bequests = sum(donations_and_bequests_2016,
                                                    na.rm = T),
                       all_other_revenue = sum(all_other_revenue_2016,
                                               na.rm = T),
                       total_revenue = sum(total_revenue_2016,
                                           na.rm = T))

Revenue16$Year <- 2016

Revenue17 <- summarise(group_by(VCOSS_ACNC_17,
                                main_activity = main_activity),
                       government_grants = sum(government_grants_2017,
                                               na.rm = T),
                       donations_and_bequests = sum(donations_and_bequests_2017,
                                                    na.rm = T),
                       all_other_revenue = sum(all_other_revenue_2017,
                                               na.rm = T),
                       total_revenue = sum(total_revenue_2017,
                                           na.rm = T))
Revenue17$Year <- 2017

Revenue1617 <- rbind(Revenue16, Revenue17)

## All other sectors

Other_Revenue1617 <- filter(Revenue1617,
                            !str_detect(main_activity, regex("social services",
                                                             ignore_case = T)))

Other_Revenue1617_long <- pivot_longer(Other_Revenue1617,
                                       -c(main_activity, Year, total_revenue),
                                       names_to = "revenue_source",
                                       values_to = "revenue_amount")

Total_Other_Revenue1617_long <- summarise(group_by(Other_Revenue1617_long,
                                                   revenue_source, Year),
                                          revenue_amount = sum(revenue_amount))


# plot

gg_Other_Revenue1617 <- ggplot(ungroup(Total_Other_Revenue1617_long),
       aes(x = as.ordered(Year),
           y = revenue_amount,
           colour = str_clean_wrap(revenue_source, 18),
           group = revenue_source,
           text = paste(sep = "\n",
                        str_clean_wrap(revenue_source),
                        dollar(revenue_amount)))) +
  geom_point() +
  geom_line(stat = "identity") +
  scale_y_continuous("Revenue amount",
                     labels = dollar,
                     limits = c(0, NA)) +
  scale_x_discrete("Year",
                   expand = c(0.05, 0.05)) +
  ggtitle("Victorian Social Services Revenue Sources") +
  scale_color_manual("",
                     values = rev(GreyGrad(3))) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

pl_Other_Revenue1617 <- ggplotly(gg_Other_Revenue1617,
                                 tooltip = "text") %>% 
  layout(font = list(family = FSSIfont))

## Social Services 

SocServ_Revenue1617 <- filter(Revenue1617,
                              str_detect(main_activity, regex("social services",
                                                               ignore_case = T)))


SocServ_Revenue1617_long <- pivot_longer(SocServ_Revenue1617,
                                       -c(main_activity, Year, total_revenue),
                                       names_to = "revenue_source",
                                       values_to = "revenue_amount")

SocServ_Revenue1617_long <- mutate(group_by(SocServ_Revenue1617_long,
                                          main_activity, Year),
                                 revenue_proportion = revenue_amount / sum(revenue_amount,
                                                                           na.rm = T),
                                 soc_serv_bool = if_else(str_detect(main_activity,
                                                                    regex("social services",
                                                                          ignore_case = T)),
                                                         true = "Social Services",
                                                         false = "Other activities"))

gg_SocServ_Revenue1617 <- ggplot(SocServ_Revenue1617_long,
                                 aes(x = as.ordered(Year),
                                     y = revenue_amount,
                                     colour = str_clean_wrap(revenue_source, 18),
                                     group = revenue_source,
                                     text = paste(sep = "\n",
                                                  str_clean_wrap(revenue_source),
                                                  dollar(revenue_amount)))) +
  geom_point() +
  stat_summary(fun.y = sum, geom = "line") +
  scale_y_continuous("Revenue amount",
                     labels = dollar,
                     limits = c(0, NA)) +
  scale_x_discrete("Year",
                   expand = c(0.05, 0.05)) +
  ggtitle("Victorian Social Services Revenue Sources") +
  scale_color_manual("Charity Size",
                     values = rev(FSSIGreenGrad(3))) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

pl_SocServ_Revenue1617 <- ggplotly(gg_SocServ_Revenue1617,
                                   tooltip = "text") %>% 
  layout(font = list(family = FSSIfont))

## bring together

subplot(pl_Other_Revenue1617, pl_SocServ_Revenue1617,
        nrows = 1, shareY = T) %>% 
  layout(xaxis = list(title = list(text = "Year\nOther Sectors",
                                   font = list(size = 13))),
         xaxis2 = list(title = list(text = "Year\nSocial Services",
                                   font = list(size = 13))))


## This seems like doubling up but it's used below

Other_Revenue1617_long <- mutate(group_by(Other_Revenue1617_long,
                                          main_activity, Year),
                                 revenue_proportion = revenue_amount / sum(revenue_amount,
                                                                           na.rm = T),
                                 soc_serv_bool = if_else(str_detect(main_activity,
                                                                    regex("social services",
                                                                          ignore_case = T)),
                                                         true = "Social Services",
                                                         false = "Other activities"))

## binding for use down below

Revenue1617_long <- rbind(Other_Revenue1617_long,
                          SocServ_Revenue1617_long)

```

### Proportion of Funding by Charity Size

```{r echo=FALSE, message=FALSE, warning=FALSE}

## 2016 
FundingSources_16_long <- pivot_longer(select(VCOSS_ACNC_16,
                                              main_activity = main_activity_2016,
                                              charity_size,
                                              government_grants = government_grants_2016,
                                              donations_and_bequests = donations_and_bequests_2016,
                                              all_other_revenue = all_other_revenue_2016),
                                       cols = c(government_grants,
                                                donations_and_bequests,
                                                all_other_revenue),
                                       names_to = "funding_source",
                                       values_to = "funding_amount")

SocServ_Total_FundingSources_16 <- filter(FundingSources_16_long,
                                          str_detect(main_activity, regex("social services",
                                                                          ignore_case = T)))

SocServ_Total_FundingSources_16 <- summarise(group_by(SocServ_Total_FundingSources_16,
                                                      charity_size, main_activity, funding_source),
                                             funding_amount = sum(funding_amount))

SocServ_Total_FundingSources_16$Year <- 2016

## 2017 
FundingSources_17_long <- pivot_longer(select(VCOSS_ACNC_17,
                                              main_activity,
                                              charity_size,
                                              government_grants = government_grants_2017,
                                              donations_and_bequests = donations_and_bequests_2017,
                                              all_other_revenue = all_other_revenue_2017),
                                       cols = c(government_grants,
                                                donations_and_bequests,
                                                all_other_revenue),
                                       names_to = "funding_source",
                                       values_to = "funding_amount")

SocServ_Total_FundingSources_17 <- filter(FundingSources_17_long,
                                          str_detect(main_activity, regex("social services",
                                                                          ignore_case = T)))

SocServ_Total_FundingSources_17 <- summarise(group_by(SocServ_Total_FundingSources_17,
                                                      charity_size, main_activity, funding_source),
                                             funding_amount = sum(funding_amount))

SocServ_Total_FundingSources_17$Year <- 2017


SocServ_Total_FundingSources_1617 <- rbind(SocServ_Total_FundingSources_16,
                                           SocServ_Total_FundingSources_17)

SocServ_Total_FundingSources_1617 <- group_by(SocServ_Total_FundingSources_1617,
                                              main_activity, charity_size, Year)

SocServ_Total_FundingSources_1617 <- mutate(SocServ_Total_FundingSources_1617,
                                            "funding_proportion" = (funding_amount / sum(funding_amount,
                                                                                         na.rm = T)))

SocServ_Total_FundingSources_1617_CharSize <- summarise(group_by(SocServ_Total_FundingSources_1617,
                                                                 charity_size, funding_source, Year),
                                                        funding_amount = sum(funding_amount, na.rm = T))

SocServ_Total_FundingSources_1617_CharSize <- mutate(group_by(SocServ_Total_FundingSources_1617_CharSize,
                                                              charity_size, Year),
                                                     funding_proportion = (funding_amount / sum(funding_amount,
                                                                                                na.rm = T)))

gg_SocServ_FundingSources_CharSize_1617 <- ggplot(SocServ_Total_FundingSources_1617_CharSize) +
  geom_bar(aes(x = funding_proportion,
               y = charity_size,
               fill = str_clean_wrap(funding_source),
               text = paste(sep = "\n",
                            str_clean_wrap(funding_source),
                            Year,
                            dollar(funding_amount),
                            percent(funding_proportion, 0.1))),
           stat = "identity") +
  scale_y_discrete("",
                   labels = function(x) str_clean_wrap(x)) +
  scale_x_continuous("Funding Proportion",
                     labels = percent_format(1)) +
  scale_fill_manual("Funding Source",
                    values = FSSIGreenGrad(3)) +
  facet_wrap(~Year,
             scales = "free_x") +
  theme_minimal()

pl_SocServ_FundingSources_CharSize_1617 <- ggplotly(gg_SocServ_FundingSources_CharSize_1617,
                                                    tooltip = "text") %>% 
  layout(font = list(family = FSSIfont,
                     size = 12),
         yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         title = list(text = "Social Services Funding Sources for each Charity Size",
                      xref = "paper",
                      x = "0"),
         margin = list(t = 55))

## 2016 
FundingSources_16_long <- pivot_longer(select(VCOSS_ACNC_16,
                                              main_activity = main_activity_2016,
                                              charity_size,
                                              government_grants = government_grants_2016,
                                              donations_and_bequests = donations_and_bequests_2016,
                                              all_other_revenue = all_other_revenue_2016),
                                       cols = c(government_grants,
                                                donations_and_bequests,
                                                all_other_revenue),
                                       names_to = "funding_source",
                                       values_to = "funding_amount")

FundingSources_16_long <- filter(FundingSources_16_long,
                                 !str_detect(main_activity, regex("social services",
                                                                  ignore_case = T)))

Total_FundingSources_16 <- summarise(group_by(FundingSources_16_long,
                                              charity_size, main_activity, funding_source),
                                     funding_amount = sum(funding_amount))

Total_FundingSources_16$Year <- 2016


## 2017

FundingSources_17_long <- pivot_longer(select(VCOSS_ACNC_17,
                                              main_activity,
                                              charity_size,
                                              government_grants = government_grants_2017,
                                              donations_and_bequests = donations_and_bequests_2017,
                                              all_other_revenue = all_other_revenue_2017),
                                       cols = c(government_grants,
                                                donations_and_bequests,
                                                all_other_revenue),
                                    names_to = "funding_source",
                                    values_to = "funding_amount")

FundingSources_17_long <- filter(FundingSources_17_long,
                                 !str_detect(main_activity, regex("social services",
                                                                  ignore_case = T)))

Total_FundingSources_17 <- summarise(group_by(FundingSources_17_long,
                                              charity_size, main_activity, funding_source),
                                     funding_amount = sum(funding_amount))

Total_FundingSources_17$Year <- 2017

Total_FundingSources_1617 <- rbind(Total_FundingSources_16, Total_FundingSources_17)

Total_FundingSources_1617 <- group_by(Total_FundingSources_1617,
                                      main_activity, charity_size, Year)

Total_FundingSources_1617 <- mutate(Total_FundingSources_1617,
                                    "funding_proportion" = (funding_amount / sum(funding_amount,
                                                                                 na.rm = T)))

Total_FundingSources_1617_CharSize <- summarise(group_by(Total_FundingSources_1617,
                                                         charity_size, funding_source, Year),
                                                funding_amount = sum(funding_amount, na.rm = T))

Total_FundingSources_1617_CharSize <- mutate(group_by(Total_FundingSources_1617_CharSize,
                                                      charity_size, Year),
                                             funding_proportion = (funding_amount / sum(funding_amount,
                                                                                        na.rm = T)))

gg_FundingSources_CharSize_1617 <- ggplot(Total_FundingSources_1617_CharSize) +
  geom_bar(aes(x = funding_proportion,
               y = charity_size,
               fill = str_clean_wrap(funding_source),
               text = paste(sep = "\n",
                            str_clean_wrap(funding_source),
                            Year,
                            dollar(funding_amount),
                            percent(funding_proportion, 0.1))),
           stat = "identity") +
  scale_y_discrete("",
                   labels = function(x) str_clean_wrap(x)) +
  scale_x_continuous("Funding Proportion",
                     labels = percent_format(1)) +
  scale_fill_manual("Funding Source",
                    values = GreyGrad(3)) +
  facet_wrap(~Year,
             scales = "free_x") +
  theme_minimal()

pl_FundingSources_CharSize_1617 <- ggplotly(gg_FundingSources_CharSize_1617,
                                            tooltip = "text") %>% 
  layout(font = list(family = FSSIfont,
                     size = 12),
         yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         margin = list(t = 55))

subplot(pl_FundingSources_CharSize_1617,
        pl_SocServ_FundingSources_CharSize_1617,
        nrows = 2, shareX = T) %>% 
  layout(showlegend = F,
         title = list(text = "Funding Sources for each Charity Size",
                      xref = "paper",
                      x = "0"),
         yaxis = list(title = list(text = "Charity Size\nOther Sectors")),
         yaxis2 = list(title = list(text = "Charity Size\nSocial Services")),
         xaxis = list(title = "Funding Proportion"),
         xaxis2 = list(title = "Funding Proportion"))

```

## Funding Sources by Main Activity {.tabset .tabset-fade}

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggFundingSources <- ggplot(Revenue1617_long) +
  geom_bar(aes(x = fct_rev(main_activity),
               y = revenue_proportion,
               group = revenue_source,
               fill = revenue_source,
               col = soc_serv_bool,
               text = paste(sep = "\n",
                            str_clean_wrap(main_activity, 20),
                            str_clean_wrap(revenue_source, 20),
                            percent(revenue_proportion, 0.1),
                            dollar(revenue_amount))),
           stat = "identity",
           show.legend = T, size = 1) +
  scale_x_discrete("",
                   labels = function(x) str_wrap(x, width = 25)) +
  scale_y_continuous("Proportion of Funding",
                     labels = percent) +
  facet_wrap(~Year) +
  scale_fill_manual(values = GreyGrad(3),
                    labels = function(x) str_to_title(str_replace_all(str_remove_all(x,"prop"),
                                                                      "_", " "))) +
  scale_colour_manual("",
                      values = c(NA, FSSIGreenSingle)) +
  coord_flip() +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_rect(fill = FSSIUltraLight,
                                        colour = NA))

ggplotly(ggFundingSources,
         tooltip = "text") %>% 
  layout(showlegend = FALSE,
         showlegend2 = FALSE,
         title = list(text = "Total Funding Sources by Main Activity",
                      pad = list(b = 10)),
         margin = list(t = 66),
         font = list(family = FSSIfont,
                     size = 12),
         yaxis = list(title = list(text = "Main Activity",
                                   standoff = 25, size = 13)))

```



# Workforce Composition {.tabset .tabset-pills}

## Employees {.tabset .tabset-fade}

### No. of staff by Staff type {.tabset .tabset-fade}

#### Other Sectors

```{r echo=FALSE, message=FALSE, warning=FALSE}

Other_Staff_CharSize_16 <- summarise(group_by(filter(VCOSS_ACNC_16,
                                                     !str_detect(main_activity_2016, 
                                                                 regex("social services", ignore_case = TRUE))),
                                              charity_size),
                                     staff_part_time = sum(staff_part_time_2016, na.rm = T),
                                     staff_full_time = sum(staff_full_time_2016, na.rm = T),
                                     staff_casual = sum(staff_casual_2016, na.rm = T),
                                     staff_volunteers = sum(staff_volunteers_2016, na.rm = T))

Other_Staff_CharSize_16 <- pivot_longer(Other_Staff_CharSize_16,
                                        cols = c(staff_part_time,
                                                 staff_full_time,
                                                 staff_casual,
                                                 staff_volunteers),
                                        names_to = "employment_type",
                                        values_to = "employee_count")


Other_Staff_CharSize_16$Year <- 2016

## staff_casual_2017 and staff_volunteers are character variables

VCOSS_ACNC_17$staff_casual_2017 <- as.numeric(VCOSS_ACNC_17$staff_casual_2017)

VCOSS_ACNC_17$staff_volunteers <- as.numeric(VCOSS_ACNC_17$staff_volunteers)

Other_Staff_CharSize_17 <- summarise(group_by(filter(VCOSS_ACNC_17,
                                                     !str_detect(main_activity,
                                                                regex("social services", ignore_case = TRUE))),
                                              charity_size),
                                     staff_part_time = sum(staff_part_time_2017, na.rm = T),
                                     staff_full_time = sum(staff_full_time_2017, na.rm = T),
                                     staff_casual = sum(as.numeric(staff_casual_2017), na.rm = T),
                                     staff_volunteers = sum(as.numeric(staff_volunteers), na.rm = T))


Other_Staff_CharSize_17 <- pivot_longer(Other_Staff_CharSize_17,
                                        cols = c(staff_part_time,
                                                 staff_full_time,
                                                 staff_casual,
                                                 staff_volunteers),
                                        names_to = "employment_type",
                                        values_to = "employee_count")

Other_Staff_CharSize_17$Year <- 2017

Other_Staff_CharSize_1617 <- rbind(Other_Staff_CharSize_16, Other_Staff_CharSize_17)

Other_Staff_CharSize_1617 <- mutate(group_by(Other_Staff_CharSize_1617,
                                             Year, charity_size),
                                    proportion = (employee_count / sum(employee_count, na.rm = T)))

gg_Other_Staff_CharSize_1617 <- ggplot(Other_Staff_CharSize_1617) +
  geom_bar(aes(x = employee_count,
               y = charity_size,
               fill = str_clean_wrap(employment_type),
               text = paste(sep = "\n",
                            str_clean_wrap(employment_type),
                            paste(comma(employee_count, 1), "employees"),
                            percent(proportion, 0.1))),
           stat = "identity") +
  facet_rep_wrap(~Year) +
  scale_fill_manual("Employment Type",
                    values = GreyGrad(4)) +
  scale_y_discrete("") +
  scale_x_continuous("Number of Employees",
                     labels = comma) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(family = FSSIfont))

pl_Other_Staff_CharSize_1617 <- ggplotly(gg_Other_Staff_CharSize_1617,
                                   tooltip = "text") %>% 
  layout(yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         font = list(family = FSSIfont))

gg_Other_Staff_CharSize_1617_prop <- ggplot(Other_Staff_CharSize_1617) +
  geom_bar(aes(x = proportion,
               y = charity_size,
               fill = str_clean_wrap(employment_type),
               text = paste(sep = "\n",
                            str_clean_wrap(employment_type),
                            percent(proportion, 0.1),
                            paste(comma(employee_count, 1)), "employees")),
           stat = "identity",
           show.legend = F) +
  facet_rep_wrap(~Year) +
  scale_fill_manual("",
                    values = GreyGrad(4)) +
  scale_y_discrete("") +
  scale_x_continuous("Number of Employees",
                     labels = percent) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(family = FSSIfont))

pl_Other_Staff_CharSize_1617_prop <- ggplotly(gg_Other_Staff_CharSize_1617_prop,
                                        tooltip = "text",
                                        showlegend = F) %>% 
  layout(yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         font = list(family = FSSIfont))

subplot(pl_Other_Staff_CharSize_1617, pl_Other_Staff_CharSize_1617_prop,
        nrows = 2, margin = 0.1) %>% 
  layout(title = list(text = "All Other Sectors Staff Employment Types per Charity Size",
                      xref = "paper",
                      x = 0),
         yaxis = list(title = list(text = "Charity Size")),
         yaxis2 = list(title = list(text = "Charity Size")),
         xaxis = list(title = list(text = "Number of Employees",
                                    standoff = 5)),
         xaxis2 = list(title = list(text = "Number of Employees",
                                    standoff = 5)),
         xaxis3 = list(title = list(text = "Pecentage of Employees",
                                    standoff = 5)),
         xaxis4 = list(title = list(text = "Pecentage of Employees",
                                    standoff = 5)),
         font = list(family = FSSIfont,
                     size = 12))

```

#### Social Services

```{r echo=FALSE, message=FALSE, warning=FALSE}

SocServ_Staff_CharSize_16 <- summarise(group_by(filter(VCOSS_ACNC_16,
                                                     str_detect(main_activity_2016, 
                                                                 regex("social services", ignore_case = TRUE))),
                                              charity_size),
                                     staff_part_time = sum(staff_part_time_2016, na.rm = T),
                                     staff_full_time = sum(staff_full_time_2016, na.rm = T),
                                     staff_casual = sum(staff_casual_2016, na.rm = T),
                                     staff_volunteers = sum(staff_volunteers_2016, na.rm = T))

SocServ_Staff_CharSize_16 <- pivot_longer(SocServ_Staff_CharSize_16,
                                        cols = c(staff_part_time,
                                                 staff_full_time,
                                                 staff_casual,
                                                 staff_volunteers),
                                        names_to = "employment_type",
                                        values_to = "employee_count")


SocServ_Staff_CharSize_16$Year <- 2016

## staff_casual_2017 and staff_volunteers are character variables

VCOSS_ACNC_17$staff_casual_2017 <- as.numeric(VCOSS_ACNC_17$staff_casual_2017)

VCOSS_ACNC_17$staff_volunteers <- as.numeric(VCOSS_ACNC_17$staff_volunteers)

SocServ_Staff_CharSize_17 <- summarise(group_by(filter(VCOSS_ACNC_17,
                                                     str_detect(main_activity,
                                                                regex("social services", ignore_case = TRUE))),
                                              charity_size),
                                     staff_part_time = sum(staff_part_time_2017, na.rm = T),
                                     staff_full_time = sum(staff_full_time_2017, na.rm = T),
                                     staff_casual = sum(as.numeric(staff_casual_2017), na.rm = T),
                                     staff_volunteers = sum(as.numeric(staff_volunteers), na.rm = T))


SocServ_Staff_CharSize_17 <- pivot_longer(SocServ_Staff_CharSize_17,
                                        cols = c(staff_part_time,
                                                 staff_full_time,
                                                 staff_casual,
                                                 staff_volunteers),
                                        names_to = "employment_type",
                                        values_to = "employee_count")

SocServ_Staff_CharSize_17$Year <- 2017

SocServ_Staff_CharSize_1617 <- rbind(SocServ_Staff_CharSize_16, SocServ_Staff_CharSize_17)

SocServ_Staff_CharSize_1617 <- mutate(group_by(SocServ_Staff_CharSize_1617,
                                             Year, charity_size),
                                    proportion = (employee_count / sum(employee_count, na.rm = T)))

gg_SocServ_Staff_CharSize_1617 <- ggplot(SocServ_Staff_CharSize_1617) +
  geom_bar(aes(x = employee_count,
               y = charity_size,
               fill = str_clean_wrap(employment_type),
               text = paste(sep = "\n",
                            str_clean_wrap(employment_type),
                            paste(comma(employee_count, 1), "employees"),
                            percent(proportion, 0.1))),
           stat = "identity") +
  facet_rep_wrap(~Year) +
  scale_fill_manual("Employment Type",
                    values = FSSIGreenGrad(4)) +
  scale_y_discrete("") +
  scale_x_continuous("Number of Employees",
                     labels = comma) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(family = FSSIfont))

pl_SocServ_Staff_CharSize_1617 <- ggplotly(gg_SocServ_Staff_CharSize_1617,
                                   tooltip = "text") %>% 
  layout(yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         font = list(family = FSSIfont))

gg_SocServ_Staff_CharSize_1617_prop <- ggplot(SocServ_Staff_CharSize_1617) +
  geom_bar(aes(x = proportion,
               y = charity_size,
               fill = str_clean_wrap(employment_type),
               text = paste(sep = "\n",
                            str_clean_wrap(employment_type),
                            percent(proportion, 0.1),
                            paste(comma(employee_count, 1)), "employees")),
           stat = "identity",
           show.legend = F) +
  facet_rep_wrap(~Year) +
  scale_fill_manual("",
                    values = FSSIGreenGrad(4)) +
  scale_y_discrete("") +
  scale_x_continuous("Number of Employees",
                     labels = percent) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(family = FSSIfont))

pl_SocServ_Staff_CharSize_1617_prop <- ggplotly(gg_SocServ_Staff_CharSize_1617_prop,
                                        tooltip = "text",
                                        showlegend = F) %>% 
  layout(yaxis = list(title = list(text = "Charity Size",
                                   standoff = 10)),
         font = list(family = FSSIfont))

subplot(pl_SocServ_Staff_CharSize_1617, pl_SocServ_Staff_CharSize_1617_prop,
        nrows = 2, margin = 0.1) %>% 
  layout(title = list(text = "All Other Sectors Staff Employment Types per Charity Size",
                      xref = "paper",
                      x = 0),
         yaxis = list(title = list(text = "Charity Size")),
         yaxis2 = list(title = list(text = "Charity Size")),
         xaxis = list(title = list(text = "Number of Employees",
                                    standoff = 5)),
         xaxis2 = list(title = list(text = "Number of Employees",
                                    standoff = 5)),
         xaxis3 = list(title = list(text = "Pecentage of Employees",
                                    standoff = 5)),
         xaxis4 = list(title = list(text = "Pecentage of Employees",
                                    standoff = 5)),
         font = list(family = FSSIfont,
                     size = 12))

```

From 2016 to 2017, the dominant staff type was changed from part-time to full-time. The number of casual staff was the smallest in both year of 2016 and  year of 2017 compared with other staff types. A slight decreasing by 4.7% in numbers of casual employees was seen in the period of 2016 to 2017 , from 36,868 to 36,551. There were changes in the number of part-time employees and the number of full-time employees as well. The number of part-time employees was decreased from 67,131 to 63,140 (10.4% drop) and the number of full-time employees was increased from 46,516 to 84,849 (15.1% increase).

### No. of staff by organization type {.tabset .tabset-fade}

#### Social Services

```{r echo=FALSE, message=FALSE, warning=FALSE}

SocServ_Staff_MainAct16 <- summarise(group_by(filter(VCOSS_ACNC_16,
                                                     str_detect(main_activity_2016,
                                                                regex("social services", ignore_case = TRUE))),
                                              main_activity = main_activity_2016),
                                     full_time = sum(staff_full_time_2016, na.rm = TRUE),
                                     part_time = sum(staff_part_time_2016, na.rm = TRUE),
                                     casual = sum(staff_casual_2016, na.rm = TRUE))

SocServ_Staff_MainAct16_long <- pivot_longer(SocServ_Staff_MainAct16,
                                             cols = c(full_time,
                                                      part_time,
                                                      casual),
                                             names_to = "employment_type",
                                             values_to = "employee_count")

SocServ_Staff_MainAct16_long$Year <- 2016


SocServ_Staff_MainAct17 <- summarise(group_by(filter(VCOSS_ACNC_17,
                                                     str_detect(main_activity,
                                                                regex("social services", ignore_case = TRUE))),
                                              main_activity),
                                     full_time = sum(staff_full_time_2017, na.rm = TRUE),
                                     part_time = sum(staff_part_time_2017, na.rm = TRUE),
                                     casual = sum(staff_casual_2017, na.rm = TRUE))

SocServ_Staff_MainAct17_long <- pivot_longer(SocServ_Staff_MainAct17,
                                             cols = c(full_time,
                                                      part_time,
                                                      casual),
                                             names_to = "employment_type",
                                             values_to = "employee_count")

SocServ_Staff_MainAct17_long$Year <- 2017

SocServ_Staff_MainAct_1617 <- rbind(SocServ_Staff_MainAct16_long, SocServ_Staff_MainAct17_long)

SocServ_Staff_MainAct_1617$Year <- as.ordered(SocServ_Staff_MainAct_1617$Year)

gg_SocServ_Staff_MainAct_1617 <- ggplot(SocServ_Staff_MainAct_1617,
                                        aes(x = Year,
                                            y = employee_count,
                                            col = str_clean_wrap(employment_type),
                                            group = str_clean_wrap(employment_type),
                                            text = paste(sep = "\n",
                                                         comma(employee_count),
                                                         str_clean_wrap(employment_type)))) +
  geom_point() +
  stat_summary(fun.y = sum, geom = "line") +
  # geom_line() +
  scale_x_discrete("Year",
                   expand = c(0.05, 0.05)) +
  scale_y_continuous("Number of Staff",
                     labels = comma,
                     expand = c(0.15, 0.15),
                     limits = c(0, NA)) +
  scale_colour_manual(values = FSSIGreenGrad(3),
                     "Employment\nType") +
  facet_rep_wrap(~str_clean_wrap(main_activity, n_characters = 38),
                 repeat.tick.labels = TRUE,
                 scales = "free_y",
                 ncol = 3) +
  ggtitle("Changes in Staff Counts by Work Loading in Other Sectors, 2016 to 2017") +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "grey90",
                                        colour = NA))

ggplotly(gg_SocServ_Staff_MainAct_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont,
                     size = 12),
         margin = list(t = 80, b = 5,
                       l = 5, r = 5,
                       pad = 2),
         yaxis = list(autorange = FALSE),
         font = list(family = FSSIfont,
                     size = 12),
         legend = list(orientation = "h",
                       yanchor = "bottom",
                       y = -0.15,
                       xanchor = "right",
                       x = 1))

```

#### Other Sectors

```{r echo=FALSE, message=FALSE, warning=FALSE}

Other_Staff_MainAct16 <- summarise(group_by(filter(VCOSS_ACNC_16,
                                                   !str_detect(main_activity_2016,
                                                               regex("social services", ignore_case = TRUE))),
                                            main_activity = main_activity_2016),
                                   full_time = sum(staff_full_time_2016, na.rm = TRUE),
                                   part_time = sum(staff_part_time_2016, na.rm = TRUE),
                                   casual = sum(staff_casual_2016, na.rm = TRUE))

Other_Staff_MainAct16_long <- pivot_longer(Other_Staff_MainAct16,
                                           cols = c(full_time,
                                                    part_time,
                                                    casual),
                                           names_to = "employment_type",
                                           values_to = "employee_count")

Other_Staff_MainAct16_long$Year <- 2016


Other_Staff_MainAct17 <- summarise(group_by(filter(VCOSS_ACNC_17,
                                                   !str_detect(main_activity,
                                                               regex("social services", ignore_case = TRUE))),
                                            main_activity),
                                   full_time = sum(staff_full_time_2017, na.rm = TRUE),
                                   part_time = sum(staff_part_time_2017, na.rm = TRUE),
                                   casual = sum(staff_casual_2017, na.rm = TRUE))

Other_Staff_MainAct17_long <- pivot_longer(Other_Staff_MainAct17,
                                           cols = c(full_time,
                                                    part_time,
                                                    casual),
                                           names_to = "employment_type",
                                           values_to = "employee_count")

Other_Staff_MainAct17_long$Year <- 2017

Other_Staff_MainAct_1617 <- rbind(Other_Staff_MainAct16_long, Other_Staff_MainAct17_long)

Other_Staff_MainAct_1617$Year <- as.ordered(Other_Staff_MainAct_1617$Year)

gg_Other_Staff_MainAct_1617 <- ggplot(Other_Staff_MainAct_1617,
                                      aes(x = Year,
                                          y = employee_count,
                                          col = str_clean_wrap(employment_type),
                                          group = str_clean_wrap(employment_type),
                                          text = paste(sep = "\n",
                                                       comma(employee_count),
                                                       str_clean_wrap(employment_type)))) +
  geom_point() +
  stat_summary(fun.y = sum, geom = "line") +
  # geom_line() +
  scale_x_discrete("Year",
                   expand = c(0.05, 0.05)) +
  scale_y_continuous("Number of Staff",
                     labels = comma,
                     expand = c(0.15, 0.15),
                     limits = c(0, NA)) +
  scale_color_brewer(palette = "Dark2",
                    "Employment\nType") +
  facet_rep_wrap(~str_clean_wrap(main_activity, n_characters = 38),
                 repeat.tick.labels = TRUE,
                 scales = "free_y",
                 ncol = 3) +
  ggtitle("Changes in Staff Counts by Work Loading in Other Sectors, 2016 to 2017") +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "grey90",
                                        colour = NA))

ggplotly(gg_Other_Staff_MainAct_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont,
                     size = 12),
         margin = list(t = 80, b = 5,
                       l = 5, r = 5,
                       pad = 2),
         yaxis = list(autorange = FALSE),
         font = list(family = FSSIfont,
                     size = 12),
         legend = list(orientation = "h",
                       yanchor = "bottom",
                       y = -0.15,
                       xanchor = "right",
                       x = 1))

```


Social services charities had the largest number of all-type employees as well as full-time and casual type employees in 2016 but in 2017, the largest number of staffs were in aged care charities. The number of staffs in social services charities accounted for 23.5% of total number of charity staffs in 2016 and was decreased to 23.4% in 2017. On the contrary, total numbers of staffs in aged care activities organizations were increased from 20.2% to 24.6%. Other health service delivery sector had the second largest number of employees and aged care activities had the third largest number of employees, which were 32,574 and 30,418 respectively in 2016. Things changed in 2017 while social services sectors and other education sectors were in the second and third place regarding to numbers of staffs. Income support and maintenance and civic and advocacy activities are seen having the smallest proportions of staffs.

## Volunteers

```{r echo=FALSE, message=FALSE, warning=FALSE}

Volunteers_MainAct_16 <- summarise(group_by(VCOSS_ACNC_16,
                                            main_activity = main_activity_2016),
                                   volunteers = sum(staff_volunteers_2016))

Volunteers_MainAct_16$Year <- 2016

Volunteers_MainAct_17 <- summarise(group_by(VCOSS_ACNC_17,
                                            main_activity),
                                   volunteers = sum(staff_volunteers))

Volunteers_MainAct_17$Year <- 2017

Volunteers_MainAct_1617 <- rbind(Volunteers_MainAct_16, Volunteers_MainAct_17)

Volunteers_MainAct_1617$Year <- as.ordered(Volunteers_MainAct_1617$Year)

gg_Volunteers_MainAct_1617 <- ggplot(Volunteers_MainAct_1617,
                                     aes(x = Year,
                                         y = volunteers,
                                         colour = str_clean_wrap(main_activity),
                                         group = main_activity,
                                         text = paste(sep = "\n",
                                                      comma(volunteers),
                                                      str_clean_wrap(main_activity)))) +
  geom_line() +
  geom_point() +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  scale_y_continuous("Number of Volunteers",
                     labels = comma) +
  scale_color_manual("Main Activity",
                     values = c(rep(GreySingle,
                                    length(unique(Volunteers_MainAct_1617$main_activity))-1),
                                FSSIGreenSingle)) +
  ggtitle("Number of Volunteers by Main Activity, 2016 to 2017") +
  theme_minimal()

ggplotly(gg_Volunteers_MainAct_1617,
         tooltip = "text") %>% 
  layout(font = list(family = FSSIfont,
                     size = 12))

```


### No. of staff by organization size {.tabset .tabset-fade}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
gg_staff_size17 <- ggplot(staff2017) +
  geom_bar(aes(x = fct_rev(fct_infreq(size)),
               label = fct_rev(fct_infreq(size)),
               fill = staff,
               text = paste(sep = "\n",
                            label,
                            fill,
                            paste("Count:", comma(..count..)),
                            paste('Percent:',round((..count..)/sum(..count..),3)*100, "%")),
           show.legend = F,stat ='identity')) +
  scale_x_discrete(" ") +
  scale_y_continuous("Number of Staffs") +
  scale_fill_manual(values = GreyGrad(length(unique(staff2017$staff))),
                    guide = F) +
  ggtitle("Number of Staffs by Type and Charity size in 2017") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

### 2016
gg_staff_size16 <- ggplot(staff2016) +
  geom_bar(aes(x = fct_rev(fct_infreq(size)),
               label = fct_rev(fct_infreq(size)),
               fill = staff,
               text = paste(sep = "\n",
                            label,
                            fill,
                            paste("Count:", comma(..count..)),
                            paste('Percent:',round((..count..)/sum(..count..),3)*100, "%")),
           show.legend = F,stat ='identity')) +
  scale_x_discrete(" ") +
  scale_y_continuous("Number of Staffs") +
  scale_fill_manual(values = GreyGrad(length(unique(staff2016$staff))),
                    guide = F) +
  ggtitle("Number of Staffs by Type and Charity size in 2016") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

proportions_staff_17 <- summarise(group_by(staff2017,
                                           size, staff),
                                  Count = n())

proportions_staff_17 <- mutate(group_by(proportions_staff_17,
                                        size),
                               proportion = (Count / sum(Count)))

gg_staff_prop_17 <- ggplot(proportions_staff_17) +
  geom_bar(aes(x = proportion,
               y = size,
               fill = staff,
               text = paste(sep = "\n",
                            percent(proportion, 0.1),
                            size,
                            staff)),
           stat = "identity") +
  scale_fill_manual(values = GreyGrad(3)) +
  scale_x_continuous("Proportion of staff",
                     labels = percent) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

pl_staff_prop_17 <- ggplotly(gg_staff_prop_17,
                             tooltip = "text")

```

#### 2016

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggplotly(gg_staff_size16,
                            tooltip = "text") %>% 
  layout(showlegend = T)

```

#### 2017

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggplotly(gg_staff_size17,
                            tooltip = "text") %>% 
  layout(showlegend = T)

```


## No. of volunteers by organization type

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
dat5 <- VCOSS_ACNC_16[,c('main_activity','staff_volunteers')]
sum(dat5$staff_volunteers)  # Numbers of Voluteer in 2016 was 408711
t4 <- data.frame(
  volunteer=unlist(apply(as.matrix(dat5[,1:2]), 1, function(x) rep(x[1],as.numeric(x[2]))))
  )

gg_vol16 <- ggplot(t4) +
  geom_bar(aes(x = fct_rev(fct_infreq(volunteer)),
               label = fct_rev(fct_infreq(volunteer)),
               fill = volunteer,
               text = paste(sep = "\n",
                            label,
                            paste("Count:", comma(..count..)),
                            paste('Percent:',round((..count..)/sum(..count..),3)*100, "%")),
           show.legend = F)) +
  scale_x_discrete("Charity type") +
  scale_y_continuous("Number of Volunteers") +
  scale_fill_manual(values = GreyGrad(length(unique(t4$volunteer))),
                    guide = F) +
  ggtitle("Number of Volunteers by Charity Type in 2016") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

dat6 <- VCOSS_ACNC_17[,c('main_activity','staff_volunteers')]
str(dat6)
dat6$staff_volunteers <- as.numeric(dat6$staff_volunteers)

sum(dat6$staff_volunteers)  # Numbers of Voluteer in 2017 was 361145
t5 <- data.frame(
  volunteer=unlist(apply(as.matrix(dat6[,1:2]), 1, function(x) rep(x[1],as.numeric(x[2]))))
  )
gg_vol17 <- ggplot(t5) +
  geom_bar(aes(x = fct_rev(fct_infreq(volunteer)),
               label = fct_rev(fct_infreq(volunteer)),
               fill = volunteer,
               text = paste(sep = "\n",
                            label,
                            paste("Count:", comma(..count..)),
                            paste('Percent:',round((..count..)/sum(..count..),3)*100, "%")),
           show.legend = F)) +
  scale_x_discrete("Charity type") +
  scale_y_continuous("Number of Volunteers") +
  scale_fill_manual(values = GreyGrad(length(unique(t5$volunteer))),
                    guide = F) +
  ggtitle("Number of Volunteers by Charity Type in 2017") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()



pl_vol16 <- ggplotly(gg_vol16,
                            tooltip = "text") %>% 
  layout(showlegend = F)


pl_vol17 <- ggplotly(gg_vol17,
                            tooltip = "text") %>% 
  layout(showlegend = F)

subplot(pl_vol16, pl_vol17,
        nrows = 1, shareY = T)

```
Civic and advocacy activites had the most volunteers in 2016 but had a huge drop from 77403 to 620 in 2017. In 2017, other education sectors got the highest numbers of volunteers. Social services were in the second place in both years and had a slightly decreasing from 75,605 to 70,289 people.

# Funding Sources {.tabset .tabset-pills}

## income source by its type {.tabset .tabset-fade}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
dat3 <- VCOSS_ACNC_16[,c('size','main_activity','govern_grants','donation_bequests','other_revenue','other_income','total_gross_income')]

# income source
t1 <- colSums(as.matrix(dat3[,3:6]))/sum(dat3[,3:6])
df1 <- data.frame(sources=names(t1),num=as.numeric(t1))
df1 <- df1[order(df1$num),]
label_value <- paste( round(df1$num/sum(df1$num) * 100, 1), '%', sep = '')
label_value

blank_theme <- theme_minimal()+
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.border = element_blank(),
    panel.grid=element_blank(),
    axis.ticks = element_blank(),
    plot.title=element_text(size=14, face="bold")
  )

gg_income16 <- ggplot(data=df1, aes(x=1:4,fill= sources,y=num,
                                   text = paste(sep = "\n",
                                                sources,
                                                paste('Percent:',round(num,3)*100, "%"))))+
  geom_bar(stat="identity",width=0.5,position='stack',size=5)+
  # coord_polar("y", start=0)+
  scale_fill_manual(values=GreyGrad(4))+
  geom_text(aes(label = label_value), size=3.2, position=position_stack(vjust = 0.5))+
  labs(x = '', y = '', title = '') +
  ggtitle("Percent of Income Sources in 2016")+
  blank_theme+
  theme(axis.text = element_blank()) + theme(axis.ticks = element_blank())

dat4 <- VCOSS_ACNC_17[,c('size','main_activity','govern_grants','donation_bequests','other_revenue','other_income','total_gross_income')]
t1_17 <- colSums(as.matrix(dat4[,3:6]))/sum(dat4[,3:6])
df1_17 <- data.frame(sources=names(t1_17),num=as.numeric(t1_17))
df1_17 <- df1_17[order(df1_17$num),]
label_value_17 <- paste( round(df1_17$num/sum(df1_17$num) * 100, 1), '%', sep = '')
label_value_17

## 17
gg_income17 <- ggplot(data=df1_17, aes(x=1:4,fill= sources,y=num,
                                   text = paste(sep = "\n",
                                                sources,
                                                paste('Percent:',round(num,3)*100, "%"))))+
  geom_bar(stat="identity",width=0.5,position='stack',size=5)+
  # coord_polar("y", start=0)+
  scale_fill_manual(values=GreyGrad(4))+
  geom_text(aes(label = label_value_17), size=3.2, position=position_stack(vjust = 0.5))+
  labs(x = '', y = '', title = '') +
  blank_theme+
  ggtitle("Percent of Income Sources in 2017")+
  theme(axis.text = element_blank()) + theme(axis.ticks = element_blank())

```

### 2016

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggplotly(gg_income16, tooltip = "text") %>% 
  layout(showlegend = T)

```

### 2017

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggplotly(gg_income17, tooltip = "text") %>% 
  layout(showlegend = T)

```
The source of income for charities are mainly government grants which accounted for 49.4% in 2016 and 73.5% in 2017. Other revenue was decreased from 39% to 11.8% whereas proportions of donation and bequests were increased from 9% to 11.9%. Other income was fluctuated between 2.6% to 2.8%.

##  source income of different organazations {.tabset .tabset-fade}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# source income of different organazations 

# 16
dat3$main_activity <- tolower(dat3$main_activity)
t2 <- aggregate(dat3[,3:7], by=list(dat3$main_activity), FUN=sum)
colnames(t2) <- c('main_activity','govern_grants','donation_bequests','other_revenue','other_income','total_gross_income')

df2<-reshape2::melt(  
  t2,  
  id.vars=c('main_activity','total_gross_income'), 
  variable.name = "sources",  
  value.name = "num"   
)  

df2 <- df2[order(df2$total_gross_income,decreasing = T),]

gg_income_type16 <- ggplot(data=df2)+geom_col(aes(x=main_activity, y=num, 
                           label=fct_rev(fct_infreq(main_activity)),
                           fill=fct_rev(fct_infreq(sources)),
                           text = paste(sep = "\n",
                                        main_activity,
                                        sources,
                     paste('Number:',num)),
                           show.legend = F,stat ='identity'))+
  scale_fill_manual(values = GreyGrad(length(unique(df2$sources))),
                    guide = F)+
  ggtitle("Source of Income by Type in 2016") +
  scale_x_discrete(" ") +
  scale_y_continuous("Income") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

### 17
t2_17 <- aggregate(dat4[,3:6], by=list(dat4$main_activity), FUN=sum)
colnames(t2_17) <- c('main_activity','govern_grants','donation_bequests','other_revenue','other_income')
df2_17<-reshape2::melt(  
  t2_17,  
  id.vars=c('main_activity'), 
  variable.name = "sources",  
  value.name = "num"   
)  

gg_income_type17 <- ggplot(data=df2_17)+geom_col(aes(x=fct_rev(fct_infreq(main_activity)), y=num, 
                           label=fct_rev(fct_infreq(main_activity)),
                           fill=fct_rev(fct_infreq(sources)),
                           text = paste(sep = "\n",
                                        main_activity,
                                        sources,
                     paste('Number:',num)),
                           show.legend = F,stat ='identity'))+
  scale_fill_manual(values = GreyGrad(length(unique(df2_17$sources))),
                   guide = F)+
  ggtitle("Source of Income by Type in 2017") +
  scale_x_discrete(" ") +
  scale_y_continuous("Income") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +coord_flip()
  
```

### 2016

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggplotly(gg_income_type16, tooltip = "text") %>% 
  layout(showlegend = T)

```

### 2017

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggplotly(gg_income_type17, tooltip = "text") %>% 
  layout(showlegend = T)

```

## Income source by organization size

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

t3 <- aggregate(dat3[,3:6], by=list(dat3$size), FUN=sum)
colnames(t3) <- c('size','govern_grants','donation_bequests','other_revenue','other_income')
df3<-reshape2::melt(  
  t3,  
  id.vars=c('size'), 
  variable.name = "sources",  
  value.name = "num"   
)  

gg_income_size16 <- ggplot(data=df3)+geom_col(aes(x=fct_rev(fct_infreq(size)), y=num, 
                           label=fct_rev(fct_infreq(size)),
                           fill=fct_rev(fct_infreq(sources)),
                           text = paste(sep = "\n",
                                        size,
                                        sources,
                     paste('Number:',num)),
                           show.legend = F,stat ='identity'),position = 'fill')+
  scale_fill_manual(values = GreyGrad(length(unique(df2$sources))),
                    guide = F)+
  ggtitle("Source of Income by Size in 2016") +
  scale_x_discrete(" ") +
  scale_y_continuous("Income") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

# 17
#### size
t3_17 <- aggregate(dat4[,3:6], by=list(dat4$size), FUN=sum)
colnames(t3_17) <- c('size','govern_grants','donation_bequests','other_revenue','other_income')
df3_17<-reshape2::melt(  
  t3_17,  
  id.vars=c('size'), 
  variable.name = "sources",  
  value.name = "num"   
)  

df3_17$size <- tolower(df3_17$size)
gg_income_size17 <- ggplot(data=df3_17)+geom_col(aes(x=fct_rev(fct_infreq(size)), y=num, 
                           label=fct_rev(fct_infreq(size)),
                           fill=fct_rev(fct_infreq(sources)),
                           text = paste(sep = "\n",
                                        size,
                                        sources,
                     paste('Number:',num)),
                           show.legend = F,stat ='identity'),position = 'fill')+
  scale_fill_manual(values = GreyGrad(length(unique(df3_17$sources))),
                    guide = F)+
  ggtitle("Source of Income by Size in 2017") +
  scale_x_discrete(" ") +
  scale_y_continuous("Income") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  coord_flip()

pl_income_size16 <- ggplotly(gg_income_size16, tooltip = "text") %>% 
  layout(showlegend = T)

pl_income_size17 <- ggplotly(gg_income_size17, tooltip = "text") %>% 
  layout(showlegend = T)

subplot(pl_income_size16, pl_income_size17,
        nrows = 1, shareY = TRUE)

```
##Deficit budget
```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

budget_deficit <- data.frame(size = c(VCOSS_ACNC_16$charity_size,VCOSS_ACNC_17$charity_size),
                  budget =c(VCOSS_ACNC_16$net_surplus_deficit_2016,VCOSS_ACNC_17$net_surplus_deficit_2017))
budget_deficit <- na.omit(budget_deficit)
budget_deficit<-  aggregate(budget ~ size, data = budget_deficit, function(x) mean(x < 0))


  
ggplot(budget_deficit, aes(size, budget)) + geom_bar(stat="identity", fill = "indianred") + theme_classic()  +   
  theme(axis.text.x = element_text(angle = 45)) + ylab("Proportion of deficit budget")


```
Small charities are more likely to have deficit buget, Large charities are least likely to have deficit budget.
# Health of Sector {.tabset .tabset-pills}

